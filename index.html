<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Dashboard Atlit Century</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <style>
    .chart-container {
      position: relative;
      width: 100%;
      min-height: 300px;
    }
    
    @media (max-width: 640px) {
      .chart-container {
        min-height: 250px;
      }
      
      .dropdown-mobile {
        width: 100% !important;
        margin-bottom: 0.5rem;
      }
      
      .heatmap-container {
        overflow-x: auto;
        padding-bottom: 10px;
      }
      
      .heatmap-grid {
        min-width: 600px;
      }
    }
  </style>
  <script>
    const ChartAnnotation = window['chartjs-plugin-annotation'];
    Chart.register(ChartAnnotation);
    Chart.register(ChartDataLabels);
  </script>
</head>
<body class="bg-gray-50 text-gray-900 p-4 sm:p-6 font-sans">
  <div class="max-w-7xl mx-auto space-y-4 sm:space-y-6">

    <header class="mb-4 sm:mb-6 bg-white border border-gray-100 rounded-2xl p-4 shadow-sm">
      <h1 class="text-2xl sm:text-3xl font-bold text-blue-700 flex items-center gap-2">🏅 Dashboard Atlit Century</h1>
      <p class="text-xs sm:text-sm text-gray-500 mt-1">Ringkasan performa, kehadiran, dan tren latihan.</p>
    </header>

    <!-- Statistik Ringkasan -->
    <div id="statCards" class="grid grid-cols-2 gap-2 sm:gap-4 sm:grid-cols-4 mb-4 sm:mb-6 text-center"></div>

    <!-- Dropdown Filter -->
    <div class="flex flex-col sm:flex-row sm:flex-wrap gap-2 sm:gap-4 mb-4">
      <select id="namaAtlet" class="p-2 border rounded dropdown-mobile w-full sm:w-1/3"></select>
      <select id="jarak" class="p-2 border rounded dropdown-mobile w-full sm:w-1/3"></select>
    </div>

    <!-- Grafik -->
    <div class="bg-white p-4 sm:p-5 rounded-2xl shadow-sm border border-gray-100 mb-4">
      <div class="chart-container">
        <canvas id="chartWaktu"></canvas>
      </div>
    </div>

    <!-- Grafik Statistik Mingguan -->
    <div class="bg-white p-4 sm:p-5 rounded-2xl shadow-sm border border-gray-100 mb-4 mt-4 sm:mt-6">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-base sm:text-lg font-semibold">📊 Statistik</h2>
        <span class="inline-block bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded-full">Rolling 28-day mean</span>
      </div>

      <!-- Switch Statistik Periodik -->
      <div class="flex flex-col sm:flex-row sm:items-center gap-2 mb-2">
        <div class="inline-flex rounded-lg border border-gray-200 p-1 bg-gray-100">
          <button id="btnWeekly" class="px-3 py-1 rounded-md bg-white shadow text-sm font-medium">Mingguan</button>
          <button id="btnMonthly" class="px-3 py-1 rounded-md text-sm font-medium">Bulanan</button>
        </div>
        <span class="text-xs text-gray-500">Ringkasan jumlah latihan (bar) & rata-rata waktu (garis).</span>
      </div>

      <div class="chart-container">
        <canvas id="chartStatistikMingguan"></canvas>
      </div>
    </div>

    <!-- Progress Kehadiran -->
    <div id="progressKehadiranContainer" class="bg-white p-4 sm:p-5 rounded-2xl shadow-sm border border-gray-100 mb-4">
      <h2 class="text-base sm:text-lg font-semibold mb-2">✅ Progress Kehadiran Bulanan</h2>
      <div class="w-full bg-gray-200 rounded-full h-4 sm:h-6">
        <div id="progressKehadiranBar" class="bg-green-500 h-4 sm:h-6 rounded-full text-white text-xs sm:text-sm text-center flex items-center justify-center" style="width: 0%">0%</div>
      </div>
      <div id="progressKehadiranText" class="text-xs sm:text-sm text-gray-600 mt-1 text-center">0/20 hari hadir</div>
    </div>

    <div id="progressContainer" class="bg-white p-4 sm:p-5 rounded-2xl shadow-sm border border-gray-100 mb-4">
      <h2 class="text-base sm:text-lg font-semibold mb-2">📊 Progress Capaian Target</h2>
      <div class="w-full bg-gray-200 rounded-full h-4 sm:h-6">
        <div id="progressBar" class="bg-blue-500 h-4 sm:h-6 rounded-full text-white text-xs sm:text-sm text-center flex items-center justify-center" style="width: 0%">0%</div>
      </div>
      <div id="progressText" class="text-xs sm:text-sm text-gray-600 mt-1 text-center">0/0 latihan capai target</div>
    </div>

    <div class="bg-white p-4 sm:p-5 rounded-2xl shadow-sm border border-gray-100 mb-4 mt-4 sm:mt-6">
      <h2 class="text-base sm:text-lg font-semibold mb-2">🎯 Total Capaian Target per Atlet</h2>
      <div class="chart-container">
        <canvas id="chartBarCapai"></canvas>
      </div>
    </div>

    <!-- Heatmap Latihan -->
    <div class="bg-white p-4 sm:p-5 rounded-2xl shadow-sm border border-gray-100 mb-4">
      <h2 class="text-base sm:text-lg font-semibold mb-2">🔥 Heatmap Kehadiran Latihan</h2>
      <div class="heatmap-container">
        <div id="heatmapContainer" class="heatmap-grid grid gap-1 text-[8px] sm:text-[10px]" style="grid-template-columns: repeat(31, minmax(0.75rem, 1rem));">
          <!-- Isi heatmap akan dibuat dinamis oleh JavaScript -->
        </div>
      </div>
      <div class="text-xs text-center text-gray-500 mt-2">*Tiap kotak = 1 hari latihan</div>
    </div>

    <footer class="mt-4 sm:mt-6 text-center text-xs sm:text-sm text-gray-500">
      &copy; 2025 Atlit Century. All rights reserved.
      <div class="mt-1">Developed with ❤️ by Al</div>
    </footer>

    <script>
      const apiBase = "https://script.google.com/macros/s/AKfycbwpAm3ve8FUdaZZM6b9Xnm-RVkWX_POlKCAvJtuvYLLP2d3lKgFp1Q5etMPi8Iyd8slfw/exec";
      let dataLatihan = [];
      let targetWaktu = [];
      let chart;
      let dataAbsensi = [];

      async function fetchData(sheet) {
        const res = await fetch(`${apiBase}?sheet=${sheet}`);
        return await res.json();
      }

      function getUniqueOptions(data, key) {
        return [...new Set(data.map(item => item[key]))];
      }

      function updateDropdown(id, options) {
        const dropdown = document.getElementById(id);
        dropdown.innerHTML = "";
        options.forEach(opt => {
          const o = document.createElement("option");
          o.value = o.textContent = opt;
          dropdown.appendChild(o);
        });
      }

      function getTarget(atlet, jarak) {
        const match = targetWaktu.find(item => item.Nama === atlet && item.Jarak === jarak);
        return match ? parseFloat(match.Target) : 25.0;
      }

      function showStatistik(data, target) {
        const total = data.length;
        const tercepat = Math.min(...data);
        const rata2 = data.reduce((a, b) => a + b, 0) / total;
        const jumlahCapaiTarget = data.filter(v => v <= target).length;

        const cardData = [
          { label: "👟 Total Latihan", value: total },
          { label: "🏁 Waktu Tercepat", value: tercepat.toFixed(2) + "s" },
          { label: "📈 Rata-rata", value: rata2.toFixed(2) + "s" },
          { label: "🎯 Capaian Target", value: jumlahCapaiTarget + "x" },
        ];

        const container = document.getElementById("statCards");
        container.innerHTML = cardData.map(c => `
          <div class="bg-white p-3 sm:p-5 rounded-2xl shadow-sm border border-gray-100 text-left">
            <div class="text-xs sm:text-sm text-gray-500">${c.label}</div>
            <div class="text-lg sm:text-xl font-bold text-blue-600">${c.value}</div>
          </div>`).join("");
      }

      function renderChart(atlet, jarak) {
        const filtered = dataLatihan.filter(item =>
          item.Nama === atlet && item.Jarak === jarak && parseFloat(item.Waktu) > 0);
        const labels = filtered.map(d => d.Tanggal);
        const waktu = filtered.map(d => parseFloat(d.Waktu));
        const target = getTarget(atlet, jarak);
        const pointColors = waktu.map(w => (w <= target ? 'green' : 'orange'));

        showStatistik(waktu, target);

        const data = {
          labels,
          datasets: [{
            label: `Performa ${jarak} - ${atlet}`,
            data: waktu,
            borderColor: '#0ea5e9',
            backgroundColor: '#38bdf8',
            fill: false,
            tension: 0.3,
            pointRadius: 5,
            pointBackgroundColor: pointColors
          }]
        };

        const config = {
          type: 'line',
          data,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: true },
              datalabels: {
                color: '#000',
                anchor: 'end',
                align: 'top',
                formatter: value => `${value.toFixed(2)}s`,
                font: {
                  size: window.innerWidth < 640 ? 10 : 12
                }
              }
            },
            scales: {
              y: {
                reverse: true,
                title: { display: true, text: 'Waktu (detik)' }
              },
              x: {
                title: { display: true, text: 'Tanggal' }
              }
            }
          },
          plugins: [ChartDataLabels]
        };

        if (chart) chart.destroy();
        chart = new Chart(document.getElementById("chartWaktu"), config);
      }

      function renderBarChart() {
        const atletList = getUniqueOptions(dataLatihan, "Nama");

        const capaiData = atletList.map(nama => {
          const atletData = dataLatihan.filter(d =>
            d.Nama === nama && parseFloat(d.Waktu) > 0
          );

          let totalCapai = 0;
          for (const d of atletData) {
            const target = getTarget(d.Nama, d.Jarak);
            if (parseFloat(d.Waktu) <= target) totalCapai++;
          }

          return { nama, capai: totalCapai };
        });

        const labels = capaiData.map(d => d.nama);
        const values = capaiData.map(d => d.capai);

        const ctx = document.getElementById("chartBarCapai").getContext("2d");
        if (window.barChart) window.barChart.destroy();

        window.barChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Jumlah Capaian Target',
              data: values,
              backgroundColor: '#22c55e'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              datalabels: {
                anchor: 'end',
                align: 'top',
                color: '#000',
                formatter: val => val,
                font: {
                  size: window.innerWidth < 640 ? 10 : 12
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                title: { display: true, text: 'Jumlah Capaian' }
              },
              x: {
                title: { display: true, text: 'Nama Atlet' }
              }
            }
          },
          plugins: [ChartDataLabels]
        });
      }

      function renderHeatmap(atlet) {
        const container = document.getElementById("heatmapContainer");
        container.innerHTML = "";
        
        const dates = dataAbsensi
          .filter(item => item.Nama === atlet && item.Status.toLowerCase() === "hadir")
          .map(item => item.Tanggal);
        
        if (dates.length === 0) return;
        
        const lastDate = new Date(dates.sort()[dates.length - 1]);
        const bulan = `${lastDate.getFullYear()}-${String(lastDate.getMonth() + 1).padStart(2, "0")}`;
        
        const hariMap = {};
        dataAbsensi.forEach(item => {
          if (
            item.Nama === atlet &&
            item.Status.toLowerCase() === "hadir" &&
            item.Tanggal.startsWith(bulan)
          ) {
            hariMap[item.Tanggal] = true;
          }
        });

        const year = parseInt(bulan.split("-")[0]);
        const month = parseInt(bulan.split("-")[1]) - 1;
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        container.style.gridTemplateColumns = `repeat(${daysInMonth}, minmax(0.75rem, 1rem))`;
        for (let i = 1; i <= daysInMonth; i++) {
          const tanggal = `${bulan}-${String(i).padStart(2, "0")}`;
          const hadir = hariMap[tanggal];
          container.innerHTML += `
            <div title="${tanggal}" class="w-3 h-3 sm:w-4 sm:h-4 rounded ${
              hadir ? "bg-green-600" : "bg-gray-200"
            }"></div>
          `;
        }
      }

      function groupByPeriod(items, period) {
        const buckets = {};
        for (const item of items) {
          const d = new Date(item.Tanggal);
          let key;
          if (period === 'monthly') {
            key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2, '0')}`;
          } else {
            const start = new Date(d);
            start.setDate(d.getDate() - d.getDay());
            key = start.toISOString().split("T")[0];
          }
          if (!buckets[key]) buckets[key] = [];
          buckets[key].push(parseFloat(item.Waktu));
        }
        return buckets;
      }

      function renderStatistikPeriodik(atlet, jarak, period='weekly') {
        const filtered = dataLatihan.filter(item =>
          item.Nama === atlet &&
          item.Jarak === jarak &&
          parseFloat(item.Waktu) > 0
        );

        const buckets = groupByPeriod(filtered, period);
        const labels = Object.keys(buckets).sort();
        const jumlahLatihan = labels.map(k => buckets[k].length);
        const rataWaktu = labels.map(k => {
          const arr = buckets[k];
          const avg = arr.reduce((a, b) => a + b, 0) / arr.length;
          return Number(avg.toFixed(2));
        });

        const ctx = document.getElementById("chartStatistikMingguan").getContext("2d");
        if (window.statistikChart) window.statistikChart.destroy();

        window.statistikChart = new Chart(ctx, {
          data: {
            labels,
            datasets: [
              { 
                type: 'bar', 
                label: 'Jumlah Latihan', 
                data: jumlahLatihan, 
                backgroundColor: '#0f766e' 
              },
              { 
                type: 'line', 
                label: 'Rata-rata Waktu (s)', 
                data: rataWaktu, 
                borderColor: '#334155', 
                backgroundColor: '#94a3b8', 
                tension: 0.35, 
                yAxisID: 'y1' 
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: { 
              legend: { 
                position: 'top',
                labels: {
                  font: {
                    size: window.innerWidth < 640 ? 10 : 12
                  }
                }
              } 
            },
            scales: {
              y: { 
                type: 'linear', 
                position: 'left', 
                title: { 
                  display: true, 
                  text: 'Jumlah Latihan',
                  font: {
                    size: window.innerWidth < 640 ? 10 : 12
                  }
                } 
              },
              y1: { 
                type: 'linear', 
                position: 'right', 
                grid: { drawOnChartArea: false }, 
                title: { 
                  display: true, 
                  text: 'Rata-rata Waktu (s)',
                  font: {
                    size: window.innerWidth < 640 ? 10 : 12
                  }
                } 
              }
            }
          }
        });
      }

      function initStatistikToggle(atlet, jarak) {
        const btnWeekly = document.getElementById('btnWeekly');
        const btnMonthly = document.getElementById('btnMonthly');
        function setActive(which) {
          if (!btnWeekly || !btnMonthly) return;
          if (which === 'weekly') {
            btnWeekly.classList.add('bg-white','shadow');
            btnMonthly.classList.remove('bg-white','shadow');
          } else {
            btnMonthly.classList.add('bg-white','shadow');
            btnWeekly.classList.remove('bg-white','shadow');
          }
        }
        btnWeekly?.addEventListener('click', () => { setActive('weekly'); renderStatistikPeriodik(atlet, jarak, 'weekly'); });
        btnMonthly?.addEventListener('click', () => { setActive('monthly'); renderStatistikPeriodik(atlet, jarak, 'monthly'); });
        setActive('weekly');
      }

      function updateProgressKehadiran(atlet) {
        const dates = dataAbsensi
          .filter(item => item.Nama === atlet && item.Status.toLowerCase() === "hadir")
          .map(item => item.Tanggal);
        
        if (dates.length === 0) return;
        
        const lastDate = new Date(dates.sort()[dates.length - 1]);
        const bulan = `${lastDate.getFullYear()}-${String(lastDate.getMonth() + 1).padStart(2, "0")}`;
        
        const hadirBulanIni = dataAbsensi.filter(item =>
          item.Nama === atlet &&
          item.Status.toLowerCase() === "hadir" &&
          item.Tanggal.startsWith(bulan)
        );

        const totalHari = 20;
        const hadir = hadirBulanIni.length;
        const persen = Math.min((hadir / totalHari * 100).toFixed(0), 100);

        const bar = document.getElementById("progressKehadiranBar");
        const text = document.getElementById("progressKehadiranText");

        bar.style.width = persen + "%";
        bar.textContent = persen + "%";
        text.textContent = `${hadir}/${totalHari} hari hadir di bulan ${bulan}`;
      }

      function updateProgressBar(atlet, jarak) {
        const filtered = dataLatihan.filter(item =>
          item.Nama === atlet &&
          item.Jarak === jarak &&
          parseFloat(item.Waktu) > 0
        );

        const target = getTarget(atlet, jarak);
        const jumlahCapai = filtered.filter(d => parseFloat(d.Waktu) <= target).length;
        const total = filtered.length;

        const persen = total > 0 ? (jumlahCapai / total * 100).toFixed(0) : 0;
        const progressBar = document.getElementById("progressBar");
        const progressText = document.getElementById("progressText");

        progressBar.style.width = persen + "%";
        progressBar.textContent = persen + "%";
        progressText.textContent = jumlahCapai + "/" + total + " latihan capai target";
      }

      async function init() {
        const [latihan, target, absensi] = await Promise.all([
          fetchData("DataLatihan"),
          fetchData("TargetWaktu"),
          fetchData("Absensi")
        ]);
        dataLatihan = latihan;
        targetWaktu = target;
        dataAbsensi = absensi;

        const atletList = getUniqueOptions(dataLatihan, "Nama");
        const jarakList = getUniqueOptions(dataLatihan, "Jarak");

        updateDropdown("namaAtlet", atletList);
        updateDropdown("jarak", jarakList);

        const namaDropdown = document.getElementById("namaAtlet");
        const jarakDropdown = document.getElementById("jarak");

        function updateChart() {
          renderChart(namaDropdown.value, jarakDropdown.value);
          renderBarChart();
          updateProgressBar(namaDropdown.value, jarakDropdown.value);
          updateProgressKehadiran(namaDropdown.value);
          renderHeatmap(namaDropdown.value);
          renderStatistikPeriodik(namaDropdown.value, jarakDropdown.value, "weekly");
          initStatistikToggle(namaDropdown.value, jarakDropdown.value);
        }

        namaDropdown.addEventListener("change", updateChart);
        jarakDropdown.addEventListener("change", updateChart);

        updateChart();
      }

      init();
    </script>
  </div>
</body>
</html>
